name: üöÄ Release
on:
  workflow_dispatch: ~
  push:
    branches:
      - main

jobs:
  release:
    strategy:
      matrix:
        build_image: ["ubuntu-24.04", "ubuntu-24.04-arm"]
        alpine: [ "3.20" ]
        php: [ "8.1", "8.2", "8.3", "8.4" ]
    runs-on: ${{ matrix.build_image }}
    steps:
      - name: ‚ÜôÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          show-progress: false
      - name: üîë Generate public keys
        run: make keys
      - name: üèóÔ∏è  Build
        run: |
          ARCH=$(uname -m)
          echo "ARCH=${ARCH}" >> "$GITHUB_OUTPUT"
          echo "Building alpine ${{ matrix.alpine }} php ${{ matrix.php }} arch ${ARCH}"
          make build ARCH=${ARCH} ALPINE=${{ matrix.alpine }} PHP=${{ matrix.php }}
      - name: üîê Get AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: üöÄ  Publish Packages
        run: |
          aws s3 sync --acl public-read \
                       --cache-control "max-age=86400" \
                       --delete \
                       _output/${{ matrix.alpine }}/php${{ matrix.php }}/${ARCH} \
                       s3://package-skpr-io/php-alpine/${{ matrix.alpine }}/php${{ matrix.php }}/${ARCH}
           # Public key for validating repository packages.
           aws s3 cp build/.abuild/skpr.rsa.pub s3://package-skpr-io/php-alpine/skpr.rsa.pub
      - name: ‚òÅÔ∏è Invalidate Cloudfront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_ID }} \
            --paths /php-alpine/${{ matrix.alpine }}/php${{ matrix.php }}/*
      - name: üßπ Clean up
        run: rm -f build/.abuild/skpr.rsa
