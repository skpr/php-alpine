# Maintainer: Nick Schuch <nick.schuch@skpr.io>

pkgname=php8.2-compass
_pkgreal=compass
pkgver=0.0.2
pkgrel=1
provides="php-compass=8.2"
pkgdesc="Compass - Probes for instrumenting PHP applications"
url="https://github.com/skpr/compass-extension"
arch="all"
license="PHP-3"
depends="php8.2-common>=8.2.0 php8.2-common<8.3.0"
makedepends="php8.2-dev>=8.2.0 php8.2-dev<8.3.0 autoconf alpine-sdk clang clang-dev"
source="php-compass-$pkgver.tar.gz::https://github.com/skpr/compass-extension/archive/refs/tags/v0.0.2.tar.gz"
builddir="$srcdir/compass-extension-0.0.2"

prepare() {
	default_prepare || return 1
}

build() {
	cd "$builddir"
	curl https://mise.run | sh
	export MISE_YES=1
	export RUSTFLAGS="-C target-feature=-crt-static"
    ~/.local/bin/mise build
}

package() {
    mkdir -p "$pkgdir"/etc/php/conf.d
    mkdir -p "$pkgdir"/usr/lib/php/modules

    cp "${builddir}/00_compass.ini" "${pkgdir}/etc/php/conf.d/00_compass.ini"
    cp "${builddir}/target/release/libcompass_extension.so" "${pkgdir}/usr/lib/php/modules/compass.so"
}

sha512sums="
03513a6f3d223f29f118d75fc5c89ed92054fb6f0ea91cfe85354462bdce4b57adaffcc7d02695b6723cff3fc1102deedccfd40425e693099fc7d3c5e7e871ba  php-compass-0.0.2.tar.gz
"
